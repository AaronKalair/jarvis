#!/usr/bin/env ruby

require File.dirname(__FILE__) + '/../lib/jarvis.rb'
require 'colored'

# Set option defaults
Jarvis.options[:logfile] = STDOUT
Jarvis.options[:ip] = "127.0.0.1"
Jarvis.options[:port] = 1337
Jarvis.options[:volume] = 100
Jarvis.options[:tempo] = 80
Jarvis.options[:testing] = false

Thread.abort_on_exception = true

# Parse command line args
OptionParser.new do |opts|
  opts.on('-s', '--seed SEED', 'Seed for the random number generator') do |s|
    Jarvis.options[:seed] = s.to_i
    srand Jarvis.options[:seed]
  end

  opts.on('-l', '--log FILE', 'File to log server output to.') do |file|
    Jarvis.options[:logfile] = file
  end

  opts.on('--no-welcome') do
    Jarvis.options[:nowelcome] = true
  end

  opts.on('-p', '--port PORT', 'Port number of Jarvis server.') do |port|
    Jarvis.options[:port] = port.to_i
  end

  opts.on('-i', '--ip IP', 'IP address of Jarvis server.') do |ip|
    Jarvis.options[:ip] = ip
  end

  opts.on('-t', '--testing', 'Boot the server in testing mode.') do
    Jarvis.options[:testing] = true
  end
end.parse!

# Set the logger format
Jarvis.log.formatter = proc do |severity, datetime, progname, msg|
  result = "[#{severity.ljust(5)} #{datetime}]: #{msg}\n"

  # Only set the colour if the logger is going to stdout. We don't want colour
  # information in log files.
  if Jarvis.options[:logfile] == STDOUT
    case severity
    when "DEBUG"
      result.blue
    when "WARN"
      result.yellow
    when "ERROR"
      result.red
    else
      result.white
    end
  else
    result
  end
end

Jarvis.log.debug "Options hash dump: #{Jarvis.options.inspect}"

Jarvis.log.info "Starting server..."

EventMachine::run do
  # hit Control + C to stop
  Signal.trap("INT")  do
    EventMachine.stop
    Jarvis::MIDI.instance.close
  end

  Signal.trap("TERM") do
    EventMachine.stop
    Jarvis::MIDI.instance.close
  end

  EventMachine::start_server Jarvis.options[:ip], Jarvis.options[:port],
    Jarvis::MusicServer

  puts `cowsay -f tux "Welcome to Jarvis."` unless Jarvis.options[:nowelcome]

  Jarvis.log.info "Server started. Listening on #{Jarvis.options[:ip]}:#{Jarvis.options[:port]}."
end
